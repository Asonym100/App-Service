trigger:
  branches:
    include:
      - main

variables:
  - group: dev-library

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Terraform_Deployment
    displayName: "Terraform Deploy to Azure"
    jobs:
      - job: Terraform
        displayName: "Terraform Init, Plan, and Apply"
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'

          - script: |
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            displayName: "Install Azure CLI"

          - script: |
              curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt update && sudo apt install terraform -y
            displayName: "Install Terraform"

          - script: terraform init
            displayName: "Terraform Init"

          - script: terraform plan -out=tfplan
            displayName: "Terraform Plan"

          - script: terraform apply -auto-approve tfplan
            displayName: "Terraform Apply"
